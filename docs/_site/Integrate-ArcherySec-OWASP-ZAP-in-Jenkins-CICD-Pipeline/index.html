<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="icon" href="/assets/images/logo.png">

    <title>Integrate ArcherySec + OWASP ZAP in Jenkins CI/CD Pipeline | ArcherySec</title>

    

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
          integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css"
          integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">

    <link href="https://fonts.googleapis.com/css?family=Audiowide%7CMerriweather:300,300i,400,400i,700,700i"
          rel="stylesheet">

    <link href="/assets/css/screen.css" rel="stylesheet">

    <link href="/assets/css/main.css" rel="stylesheet">

</head>




<body class="layout-post">


<!-- Begin Menu Navigation
================================================== -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
    <link rel="shortcut icon" href="assets/images/logo-128x128.png" type="image/x-icon">
    <meta name="description" content="ArcherySec Blogs">
    <title>Blog</title>
    <link rel="stylesheet" href="/assets/web/assets/mobirise-icons-bold/mobirise-icons-bold.css">
  <!--   <link rel="stylesheet" href="/assets/tether/tether.min.css">
    <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap-grid.min.css">
    <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap-reboot.min.css">
    <link rel="stylesheet" href="/assets/socicon/css/styles.css"> -->
    <link rel="stylesheet" href="/assets/dropdown/css/style.css">
    <link rel="stylesheet" href="/assets/animatecss/animate.min.css">
    <!-- <link rel="stylesheet" href="/assets/gdpr-plugin/gdpr-styles.css"> -->
    <!-- <link rel="stylesheet" href="/assets/theme/css/style.css"> -->
    <link rel="stylesheet" href="/assets/mobirise/css/mbr-additional.css" type="text/css">


</head>
<body>
<section class="menu cid-qFMlGsng2m" once="menu" id="menu1-1q">


    <nav class="navbar navbar-expand beta-menu navbar-dropdown align-items-center navbar-fixed-top navbar-toggleable-sm">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
                data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
            </div>
        </button>
        <div class="menu-logo">
            <div class="navbar-brand">
                <span class="navbar-logo">
                    <a href="http://archerysec.com">
                         <img src="/assets/images/archery-460x118.png" alt="Archery" title="Archery"
                              style="height: 3.8rem;">
                    </a>
                </span>
                <span class="navbar-caption-wrap"><a class="navbar-caption text-white display-4"
                                                     href="https://mobirise.com"></a></span>
            </div>
        </div>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav nav-dropdown" data-app-modern-menu="true">
                <li class="nav-item">
                    <a class="nav-link link text-white display-7" href="https://archerysec.com/index.html">HOME</a>
                </li>
                <li class="nav-item"><a class="nav-link link text-white display-7"
                                        href="https://archerysec.com/index.html#header3-12">OVERVIEW</a></li>
                <li class="nav-item"><a class="nav-link link text-white display-7" href="https://blog.archerysec.com">BLOG</a></li>
                <li class="nav-item"><a class="nav-link link text-white display-7" href="https://archerysec.com/index.html#header3-11">SCREENSHOTS</a>
                </li>
                <li class="nav-item"><a class="nav-link link text-white display-7"
                                        href="https://archerysec.com/index.html#tabs3-13">FEATURES</a></li>
                <li class="nav-item"><a class="nav-link link text-white display-7"
                                        href="https://github.com/archerysec/archerysec/releases/"
                                        target="_blank">DOWNLOAD</a></li>
            </ul>
        </div>
    </nav>
</section>


<script src="/assets/web/assets/jquery/jquery.min.js"></script>
<script src="/assets/popper/popper.min.js"></script>
<script src="/assets/tether/tether.min.js"></script>
<script src="/assets/bootstrap/js/bootstrap.min.js"></script>
<script src="/assets/smoothscroll/smooth-scroll.js"></script>
<script src="/assets/cookies-alert-plugin/cookies-alert-core.js"></script>
<script src="/assets/cookies-alert-plugin/cookies-alert-script.js"></script>
<script src="/assets/dropdown/js/script.min.js"></script>
<script src="/assets/touchswipe/jquery.touch-swipe.min.js"></script>
<script src="/assets/viewportchecker/jquery.viewportchecker.js"></script>
<script src="/assets/theme/js/script.js"></script>

<input name="animation" type="hidden">
<input name="cookieData" type="hidden"
       data-cookie-text="We use cookies to give you the best experience. Read our <a href='privacy.html'>cookie policy</a>.">
</body>
</html>

<!-- End Navigation
================================================== -->
<div class="site-content">
    <div class="container">
        <!-- Site Title
        ================================================== -->
        <!-- <div class="mainheading">
            <h1 class="display-5" align="center" style="color: #d14;">Blog</h1>
        </div> -->
        <!-- Content
        ================================================== -->
        <div class="row">
            <div class="col">
                <!-- Begin Article
================================================== -->
<div class="container-fluid">
	<div class="row">

		<!-- Post Share -->
		<div class="col-md-2 pl-0">  
        <div class="share sticky-top sticky-top-offset">          
           <div class="share">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
        <a target="_blank" href="https://twitter.com/intent/tweet?text=Integrate ArcherySec + OWASP ZAP in Jenkins CI/CD Pipeline&url=http://localhost:4000/Integrate-ArcherySec-OWASP-ZAP-in-Jenkins-CICD-Pipeline/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <i class="fab fa-twitter"></i>
        </a>
        </li>
        
        <li class="ml-1 mr-1">
        <a target="_blank" href="https://facebook.com/sharer.php?u=http://localhost:4000/Integrate-ArcherySec-OWASP-ZAP-in-Jenkins-CICD-Pipeline/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
        <i class="fab fa-facebook-f"></i>
        </a>
        </li>
        
        <li class="ml-1 mr-1">
         <a href="http://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/Integrate-ArcherySec-OWASP-ZAP-in-Jenkins-CICD-Pipeline/&title=Integrate ArcherySec + OWASP ZAP in Jenkins CI/CD Pipeline&summary=&source=http://localhost:4000" 
    rel="nofollow" target="_blank" title="Share On LinkedIn" class="z-2 z-h social li">
        <i class="fab fa-linkedin"></i>
    </a>
        </li>
        
    </ul>
    
    <div class="sep">
    </div>				
    <ul>
        <li> 
        <a  class="small smoothscroll" href="#disqus_thread"></a>
        </li>
    </ul>
    
</div>  
       </div>
		</div>
		

		<!-- Post -->        
        
        
		<div class="col-md-9 flex-first flex-md-unordered">
			<div class="">

                <!-- Author Box -->
                
				<div class="row post-top-meta">
					<div class="col-md-2">
						<img class="author-thumb" src="https://www.gravatar.com/avatar/d456f7972a30e67bbb05b393dcd4e996?s=250&d=mm&r=x" alt="Anand Tiwari">
					</div>
					<div class="col-md-10">
						<a target="_blank" class="link-dark" href="https://archerysec.com">Anand Tiwari</a><a target="_blank" href="https://twitter.com/anandtiwarics" class="btn follow">Follow</a>
                        <br>
						<span class="author-description">InfoSecurity Enthusiast, Author of ArcherySec tool.</span>
					</div>
				</div>
                

			</div>
            <!-- Post Title -->
                <h3 class="posttitle">Integrate ArcherySec + OWASP ZAP in Jenkins CI/CD Pipeline</h1>
                <br>

			<!-- Post Featured Image -->
			<!-- <img class="featured-image img-fluid" src="/assets/images/jenkins/archery+jenkins.png" alt="Integrate ArcherySec + OWASP ZAP in Jenkins CI/CD Pipeline"> -->
			<!-- End Featured Image -->

			<!-- Post Content -->
			<div class="article-post">
				<p>Continuous Integration / Continuous Deployment (CI/CD) processes allow software developers to detect problems early in the development lifecycle and improve productivity with automation.</p>

<p><em> “<a href="http://jenkins.io">Jenkins</a> is a popular open-source continuous integration solution that helps teams manage the automation of software build, as well as monitor the execution of external jobs that supports the software build.”</em></p>

<p>When you run security testing in your CI/CD pipeline, you want to store vulnerability data in centralize way and manage them easily for your every single pipeline. DevOps teams are facing challenges to have a central place where they can visualize vulnerabilities transparently. Vulnerability Management is one of the challenging part for every organization.</p>

<p>In this article we’ll be going learn how to integrate Archery tool in your jenkins CI/CD pipeline.</p>

<blockquote><em>"ArcherySec is an open source vulnerability assessment and management tool that helps developer and pentester to perform vulnerability assessment and manage vulnerabilities."</em></blockquote>

<p>Archery has <a href="https://developers.archerysec.com/">API</a> that interact with Archery tool and automate vulnerability assessment process.</p>

<p><a href="https://github.com/archerysec/archerysec-cli">Archerysec-cli</a> uses the API to interact Archery tool from console. We often use archerysec-cli in our CI/CD pipeline steps to perform scan and feed vulnerability data into Archery tool.</p>

<h3 id="configure-lab-environment">Configure Lab Environment:</h3>

<p>Requirements:</p>
<ul>
  <li>Docker &amp; docker-compose</li>
</ul>

<p>Steps to configure Lab Environment.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git clone https://github.com/archerysec/jenkins_blog.git
$ cd jenkins_blog
$ run docker-compose up --build
</code></pre></div></div>

<p>We have written small scripts and Infrastructure as a code that allow you to spin up environment on your system.</p>

<p>docker-compose.yml</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: <span class="s1">'3.6'</span>

services:
  jenkins:
    build: ./jenkins
    ports:
      - <span class="s2">"8080:8080"</span>
      - <span class="s2">"50000:50000"</span>
    volumes:
      - ./jenkins_home:/var/jenkins_home
    expose:
      - <span class="s2">"8080"</span>
      - <span class="s2">"50000"</span>
    container_name: jenkins
    
  db:
    image: postgres:10.1-alpine
    volumes:
      - ./dbdata:/var/lib/postgresql/data
    environment:
      - <span class="nv">POSTGRES_DB</span><span class="o">=</span>archerysec
      - <span class="nv">POSTGRES_PASSWORD</span><span class="o">=</span>archerysec
      - <span class="nv">POSTGRES_USER</span><span class="o">=</span>archerysec

  archerysec:
    image: archerysec/archerysec
    ports:
      - <span class="s2">"8000:8000"</span>
    expose:
      - <span class="s2">"8000"</span>
    depends_on:
      - db
    links:
      - db:db
    environment:
      - <span class="nv">DB_PASSWORD</span><span class="o">=</span>archerysec
      - <span class="nv">DB_USER</span><span class="o">=</span>archerysec
      - <span class="nv">DB_NAME</span><span class="o">=</span>archerysec
      - <span class="nv">DB_HOST</span><span class="o">=</span>db
      - <span class="nv">DJANGO_SETTINGS_MODULE</span><span class="o">=</span>archerysecurity.settings.development
      - <span class="nv">DJANGO_SECRET_KEY</span><span class="o">=</span><span class="k">${</span><span class="nv">DJANGO_SECRET_KEY</span><span class="k">:-</span><span class="s2">"SETME"</span><span class="k">}</span>
      - <span class="nv">DJANGO_DEBUG</span><span class="o">=</span>1
    container_name: archerysec
   
  zaproxy:
    image: owasp/zap2docker-stable
    <span class="nb">command</span>: zap.sh <span class="nt">-daemon</span> <span class="nt">-host</span> 0.0.0.0 <span class="nt">-port</span> 8090 <span class="nt">-config</span> api.disablekey<span class="o">=</span><span class="nb">true</span> <span class="nt">-config</span> api.addrs.addr.name<span class="o">=</span>.<span class="k">*</span> <span class="nt">-config</span> api.addrs.addr.regex<span class="o">=</span><span class="nb">true
    </span>ports:
      - <span class="s2">"8090:8090"</span>
    expose:
    <span class="c"># ZAP is running on 8090, we want it to be accessible by our tools</span>
      - <span class="s2">"8090"</span>
    links:
      - archerysec
    container_name: zapscanner
</code></pre></div></div>

<p>Once containers are up and running you could check whether they are accessible or not by accessing the below URL’s.</p>

<p>ArcherySec: http://your_system_ip_address:8000<br />
Jenkins: http://your_system_ip_address:8080<br />
OWASP ZAP: http://your_system_ip_address:8090</p>

<h4 id="connect-zap-with-archerysec">Connect ZAP with ArcherySec</h4>

<ul>
  <li>Open ArcherySec portal.</li>
  <li>Go to settings page http://your_system_ip_address:8000/webscanners/setting/.</li>
  <li>Edit ZAP Settings.</li>
  <li>Provide ZAP API Host &amp; ZAP API Port</li>
</ul>

<center><div class="img-border" style="width: 70%;"><img src="/assets/images/jenkins/zap_setting_archery.png" /></div></center>

<p><br /></p>

<p>Next thing we need to install archerysec-cli tool on jenkins server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>pip <span class="nb">install </span>archerysec-cli
Or 
<span class="nv">$ </span>git clone https://github.com/archerysec/archerysec-cli.git
<span class="nv">$ </span><span class="nb">cd </span>archerysec-cli
<span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># Install jq tool</span>
<span class="nb">sudo </span>apt-get <span class="nb">install </span>jq

</code></pre></div></div>

<p>We can create project using CLI commands:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>archerysec-cli <span class="nt">-s</span> http://127.0.0.1:8000 <span class="nt">-u</span> admin <span class="nt">-p</span> admin <span class="nt">--createproject</span> <span class="se">\</span>
 <span class="nt">--project_name</span><span class="o">=</span>test_project <span class="nt">--project_disc</span><span class="o">=</span><span class="s2">"test project"</span> <span class="nt">--project_start</span><span class="o">=</span>2018-01-11 <span class="se">\</span>
  <span class="nt">--project_end</span><span class="o">=</span>2018-01-11 <span class="nt">--project_owner</span><span class="o">=</span>anand
</code></pre></div></div>
<p>Output:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span><span class="s2">"message"</span>: <span class="s2">"Project Created"</span>, <span class="s2">"project_id"</span>: <span class="s2">"8b4303bc-2cd6-4212-8801-231e8b10be4d"</span><span class="o">}</span>
</code></pre></div></div>

<p>We can launch scan(s) using CLI:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>archerysec-cli <span class="nt">-s</span> http://127.0.0.1:8000 <span class="nt">-u</span> admin <span class="nt">-p</span> admin <span class="se">\</span>
 <span class="nt">--zapscan</span> <span class="nt">--target_url</span><span class="o">=</span>http://demo.testfire.net <span class="se">\</span>
  <span class="nt">--project_id</span><span class="o">=</span>8b4303bc-2cd6-4212-8801-231e8b10be4d
</code></pre></div></div>
<p>Output:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span><span class="s2">"message"</span>: <span class="s2">"Scan Launched"</span>, <span class="s2">"scanid"</span>: <span class="s2">"23a9ea3f-088d-4155-9585-5eb1ae483ef8"</span><span class="o">}</span>
</code></pre></div></div>

<p>Get the scan status:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>archerysec-cli <span class="nt">-s</span> http://127.0.0.1:8000 <span class="nt">-u</span> admin <span class="nt">-p</span> admin <span class="se">\</span>
 <span class="nt">--zapscanstatus</span> <span class="nt">--scan_id</span><span class="o">=</span>23a9ea3f-088d-4155-9585-5eb1ae483ef8
</code></pre></div></div>
<p>Output:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[{</span><span class="s2">"scan_url"</span>: <span class="s2">"http://demo.testfire.net"</span>, <span class="s2">"medium_vul"</span>: null, <span class="s2">"rescan_id"</span>: null, <span class="s2">"
date_time"</span>: <span class="s2">"2019-02-27T04:43:40.254359Z"</span>, <span class="s2">"vul_status"</span>: 1, <span class="s2">"low_vul"</span>: null,
 <span class="s2">"rescan"</span>: <span class="s2">"No"</span>, <span class="s2">"vul_num"</span>: <span class="s2">""</span>, <span class="s2">"scan_scanid"</span>: <span class="s2">"23a9ea3f-088d-4155-9585-5eb1ae483ef8"</span>,
  <span class="s2">"total_dup"</span>: null, <span class="s2">"project_id"</span>: <span class="s2">"8b4303bc-2cd6-4212-8801-231e8b10be4d"</span>, 
  <span class="s2">"high_vul"</span>: null, <span class="s2">"total_vul"</span>: null<span class="o">}]</span>
</code></pre></div></div>
<p>Get the scan results:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>archerysec-cli <span class="nt">-s</span> http://127.0.0.1:8000 <span class="nt">-u</span> admin <span class="nt">-p</span> admin <span class="nt">--zapscanresult</span> <span class="se">\</span>
  <span class="nt">--scan_id</span><span class="o">=</span>049b8207-f092-4f6f-b375-92ed541dc662
</code></pre></div></div>

<p>Let’s automate these steps using bash and python scripts.</p>
<ul>
  <li>Install archerysec-cli</li>
  <li>Create Project and get the Project ID</li>
  <li>Launch ZAP Scan and retrieve scan ID</li>
  <li>Check the scan status.</li>
  <li>Grab the vulnerability statistics.</li>
</ul>

<p>archerysec_script.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pyArchery</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span><span class="p">,</span> <span class="n">OptionGroup</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">()</span>

<span class="n">group</span> <span class="o">=</span> <span class="n">OptionGroup</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span>
                   <span class="s">""</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_option_group</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
<span class="n">group</span> <span class="o">=</span> <span class="n">OptionGroup</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="s">"Archery Scan status"</span><span class="p">,</span>
                   <span class="s">"Upload multiple scanners reports"</span>
                   <span class="p">)</span>
<span class="n">group</span><span class="p">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">"--scanner"</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s">"Input input scanner name i.e zap_scan, arachni_scan"</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">)</span>
<span class="n">group</span><span class="p">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">"--scan_id"</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s">"Input Scan Id"</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">)</span>
<span class="n">group</span><span class="p">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">"--username"</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s">"Input ArcherySec Username"</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">)</span>
<span class="n">group</span><span class="p">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">"--password"</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s">"Input ArcherySec Password"</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">)</span>
<span class="n">group</span><span class="p">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">"--host"</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s">"Input ArcherySec Host"</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">)</span>
<span class="n">group</span><span class="p">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">"-r"</span><span class="p">,</span> <span class="s">"--high"</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s">"Numbers of issue"</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">)</span>
<span class="n">group</span><span class="p">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">"-m"</span><span class="p">,</span> <span class="s">"--medium"</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s">"Numbers of issue"</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s">"store"</span><span class="p">)</span>
<span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">archery_host</span><span class="p">():</span>
   <span class="c1"># Setup archery connection
</span>   <span class="n">archery</span> <span class="o">=</span> <span class="n">api</span><span class="p">.</span><span class="n">ArcheryAPI</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">host</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">archery</span>

<span class="k">def</span> <span class="nf">archery_auth</span><span class="p">():</span>
   <span class="c1"># Set Archery url
</span>   <span class="n">archery</span> <span class="o">=</span> <span class="n">archery_host</span><span class="p">()</span>

   <span class="c1"># Provide Archery Credentials for authentication.
</span>   <span class="n">authenticate</span> <span class="o">=</span> <span class="n">archery</span><span class="p">.</span><span class="n">archery_auth</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">username</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">password</span><span class="p">)</span>

   <span class="c1"># Collect Token after authentication
</span>   <span class="n">token</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">.</span><span class="n">data</span>
   <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">token</span><span class="p">.</span><span class="n">viewitems</span><span class="p">():</span>
       <span class="n">token</span> <span class="o">=</span> <span class="n">value</span>
   <span class="k">return</span> <span class="n">token</span>

<span class="c1"># Get the scan result
</span><span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">scanner</span> <span class="o">==</span> <span class="s">'zap_scan'</span><span class="p">:</span>
   <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
   <span class="n">archery</span> <span class="o">=</span> <span class="n">archery_host</span><span class="p">()</span>
   <span class="n">web_scan_result</span> <span class="o">=</span> <span class="n">archery</span><span class="p">.</span><span class="n">zap_scan_status</span><span class="p">(</span>
       <span class="n">auth</span><span class="o">=</span><span class="n">archery_auth</span><span class="p">(),</span>
       <span class="n">scan_id</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">scan_id</span><span class="p">,</span>
   <span class="p">)</span>
   <span class="n">results</span> <span class="o">=</span> <span class="n">web_scan_result</span><span class="p">.</span><span class="n">data_json</span><span class="p">()</span>
   <span class="n">j_result</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
   <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">j_result</span><span class="p">:</span>
       <span class="n">scan_status</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="s">'vul_status'</span><span class="p">]</span>
       <span class="k">print</span> <span class="n">scan_status</span>
       <span class="k">while</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">scan_status</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">):</span>
           <span class="n">web_scan_result</span> <span class="o">=</span> <span class="n">archery</span><span class="p">.</span><span class="n">zap_scan_status</span><span class="p">(</span>
               <span class="n">auth</span><span class="o">=</span><span class="n">archery_auth</span><span class="p">(),</span>
               <span class="n">scan_id</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">scan_id</span><span class="p">,</span>
           <span class="p">)</span>
           <span class="n">results</span> <span class="o">=</span> <span class="n">web_scan_result</span><span class="p">.</span><span class="n">data_json</span><span class="p">()</span>
           <span class="n">j_result</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
           <span class="k">try</span><span class="p">:</span>
               <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">j_result</span><span class="p">:</span>
                   <span class="n">scan_status</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="s">'vul_status'</span><span class="p">]</span>
           <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
               <span class="n">scan_status</span> <span class="o">=</span> <span class="mi">100</span>
           <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
           <span class="k">print</span> <span class="s">"Scan Status"</span><span class="p">,</span> <span class="n">scan_status</span>
       <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
      
       <span class="n">web_scan_result</span> <span class="o">=</span> <span class="n">archery</span><span class="p">.</span><span class="n">zap_scan_status</span><span class="p">(</span>
           <span class="n">auth</span><span class="o">=</span><span class="n">archery_auth</span><span class="p">(),</span>
           <span class="n">scan_id</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">scan_id</span><span class="p">,</span>
       <span class="p">)</span>
       <span class="n">results</span> <span class="o">=</span> <span class="n">web_scan_result</span><span class="p">.</span><span class="n">data_json</span><span class="p">()</span>
       <span class="n">j_result</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
       <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">j_result</span><span class="p">:</span>
           <span class="n">total_vul</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="s">'total_vul'</span><span class="p">]</span>
           <span class="n">high_vul</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="s">'high_vul'</span><span class="p">]</span>
           <span class="n">medium_vul</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="s">'medium_vul'</span><span class="p">]</span>
           <span class="n">low_vul</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="s">'low_vul'</span><span class="p">]</span>
       <span class="k">print</span> <span class="s">"Total Vul"</span><span class="p">,</span> <span class="n">total_vul</span>
       <span class="k">print</span> <span class="s">"Total High"</span><span class="p">,</span> <span class="n">high_vul</span>
       <span class="k">print</span> <span class="s">"Total Medium"</span><span class="p">,</span> <span class="n">medium_vul</span>
       <span class="k">print</span> <span class="s">"Total Low"</span><span class="p">,</span> <span class="n">low_vul</span>
       <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">high_vul</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">high</span><span class="p">):</span>
           <span class="n">fail</span> <span class="o">=</span> <span class="s">"FAILURE"</span>
           <span class="k">print</span> <span class="s">"Coz total high Vulnerability"</span><span class="p">,</span> <span class="n">high_vul</span>
       <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">medium_vul</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">medium</span><span class="p">):</span>
           <span class="n">fail</span> <span class="o">=</span> <span class="s">"FAILURE"</span>
           <span class="k">print</span> <span class="s">"Coz total Medium Vulnerability"</span><span class="p">,</span> <span class="n">medium_vul</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="n">fail</span> <span class="o">=</span> <span class="s">"SUCCESS"</span>
           <span class="k">print</span> <span class="s">"Test Passed"</span>

       <span class="k">print</span> <span class="n">fail</span>

</code></pre></div></div>

<p>zapscan.sh</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
pip <span class="nb">install </span>archerysec-cli

<span class="nv">DATE</span><span class="o">=</span><span class="sb">`</span><span class="nb">date</span> +%Y-%m-%d<span class="sb">`</span>
<span class="nv">TARGET_URL</span><span class="o">=</span>http://demo.testfire.net
<span class="nv">ARCHERY_USER</span><span class="o">=</span>admin
<span class="nv">ARCHERY_PASS</span><span class="o">=</span>admin

<span class="nb">export </span><span class="nv">PROJECT_ID</span><span class="o">=</span><span class="sb">`</span>archerysec-cli <span class="nt">-s</span> <span class="k">${</span><span class="nv">ARCHERY_HOST</span><span class="k">}</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">ARCHERY_USER</span><span class="k">}</span> <span class="nt">-p</span> <span class="k">${</span><span class="nv">ARCHERY_PASS</span><span class="k">}</span> <span class="nt">--createproject</span> <span class="nt">--project_name</span><span class="o">=</span>DevSecOps <span class="nt">--project_disc</span><span class="o">=</span>PROJECT_DISC <span class="nt">--project_start</span><span class="o">=</span><span class="k">${</span><span class="nv">DATE</span><span class="k">}</span>  <span class="nt">--project_end</span><span class="o">=</span><span class="k">${</span><span class="nv">DATE</span><span class="k">}</span> <span class="nt">--project_owner</span><span class="o">=</span>test_project | <span class="nb">tail</span> <span class="nt">-n1</span> | jq <span class="s1">'.project_id'</span> | <span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s/^"//'</span> <span class="nt">-e</span> <span class="s1">'s/"$//'</span><span class="sb">`</span>
<span class="nb">export </span><span class="nv">SCAN_ID</span><span class="o">=</span><span class="sb">`</span>archerysec-cli <span class="nt">-s</span> <span class="k">${</span><span class="nv">ARCHERY_HOST</span><span class="k">}</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">ARCHERY_USER</span><span class="k">}</span> <span class="nt">-p</span> <span class="k">${</span><span class="nv">ARCHERY_PASS</span><span class="k">}</span> <span class="nt">--zapscan</span> <span class="nt">--target_url</span><span class="o">=</span><span class="s1">''</span><span class="k">${</span><span class="nv">TARGET_URL</span><span class="k">}</span><span class="s1">''</span> <span class="nt">--project_id</span><span class="o">=</span><span class="s1">''</span><span class="nv">$PROJECT_ID</span><span class="s1">''</span> | <span class="nb">tail</span> <span class="nt">-n1</span> | jq <span class="s1">'.scanid'</span> | <span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s/^"//'</span> <span class="nt">-e</span> <span class="s1">'s/"$//'</span><span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">"scan id......"</span> <span class="nv">$SCAN_ID</span>
python /var/jenkins_home/archery_script.py <span class="nt">--scanner</span><span class="o">=</span>zap_scan <span class="nt">--scan_id</span><span class="o">=</span><span class="nv">$SCAN_ID</span> <span class="nt">--username</span><span class="o">=</span><span class="k">${</span><span class="nv">ARCHERY_USER</span><span class="k">}</span> <span class="nt">--password</span><span class="o">=</span><span class="k">${</span><span class="nv">ARCHERY_PASS</span><span class="k">}</span> <span class="nt">--host</span><span class="o">=</span><span class="k">${</span><span class="nv">ARCHERY_HOST</span><span class="k">}</span> <span class="nt">--high</span><span class="o">=</span>10 <span class="nt">--medium</span><span class="o">=</span>15
<span class="nb">export </span><span class="nv">job_status</span><span class="o">=</span><span class="sb">`</span>python /var/jenkins_home/archery_script.py <span class="nt">--scanner</span><span class="o">=</span>zap_scan <span class="nt">--scan_id</span><span class="o">=</span><span class="nv">$SCAN_ID</span> <span class="nt">--username</span><span class="o">=</span><span class="k">${</span><span class="nv">ARCHERY_USER</span><span class="k">}</span> <span class="nt">--password</span><span class="o">=</span><span class="k">${</span><span class="nv">ARCHERY_PASS</span><span class="k">}</span> <span class="nt">--host</span><span class="o">=</span><span class="k">${</span><span class="nv">ARCHERY_HOST</span><span class="k">}</span> <span class="nt">--high</span><span class="o">=</span>10 <span class="nt">--medium</span><span class="o">=</span>15<span class="sb">`</span><span class="o">]</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$job_status</span><span class="s2">"</span> <span class="o">]</span>
<span class="k">then
   </span><span class="nb">echo</span> <span class="s2">"Build Sucess"</span>
<span class="k">else
 </span><span class="nb">echo</span> <span class="s2">"BUILD FAILURE: Other build is unsuccessful or status could not be obtained."</span>
 <span class="nb">exit </span>100
<span class="k">fi</span>
</code></pre></div></div>

<p>Now run all these script on Jenkins CI pipeline.</p>

<ul>
  <li>Login into Jenkins server.</li>
  <li>Create new job.</li>
  <li>Give the name of the job and select as pipeline.</li>
  <li>Go to pipeline section and copy paste  below code.</li>
</ul>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">pipeline</span> <span class="o">{</span>
  <span class="n">agent</span> <span class="n">any</span>
  <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'DAST'</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">parallel</span> <span class="o">{</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">'OWASP ZAP'</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">agent</span> <span class="n">any</span>
              <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s1">'''
                 export ARCHERY_HOST=http://your_system_ip_address:8000
                     bash /var/jenkins_home/zapscan.sh
                  '''</span>
              <span class="o">}</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Replace ARCHERY_HOST value with your system IP address.</li>
</ul>

<center><div class="img-border" style="width: 70%;"><img src="/assets/images/jenkins/pipeline_content.png" /></div></center>

<p><br /></p>

<ul>
  <li>Apply and save.</li>
  <li>Now click on Build Now.</li>
  <li>Go to Console Output and notice that the scripts are running.</li>
</ul>

<center><div class="img-border" style="width: 70%;"><img src="/assets/images/jenkins/jenkins_ruuning_zap.png" /></div></center>
<p><br /></p>

<p>Now open ArcherySec and go to Dynamic Scans &gt; ZAP Scans. Notice that the scan are running and given the running status % of scan.</p>

<center><div class="img-border" style="width: 70%;"><img src="/assets/images/jenkins/blog_archery_running.png" /></div></center>

<p><br /></p>

<p>Jenkins will now run OWASP ZAP using ArcherySec at your desired frequency and will tell you whether the build failed or succeeded. In a bigger setup, ArcherySec will be part of your build process. You can set up notifications and customize Jenkins as per your needs.
You can use a wide variety of other configurations to make your collection more dynamic.</p>

<h4 id="conclusion">Conclusion</h4>

<p>Following the steps above, you will be able to set up a continuous integration process that includes ArcherySec automated Dynamic OWASP ZAP tests for the application under scan. Each commit will trigger an automated test run. Once the test run has finished, you’ll able to manage vulnerabilities using ArcherySec Tool.</p>

<h4 id="learn-more">Learn More</h4>

<ul>
  <li><a href="http://www.archerysec.com/">http://www.archerysec.com/</a></li>
  <li><a href="https://github.com/archerysec/archerysec">https://github.com/archerysec/archerysec</a></li>
  <li><a href="https://docs.archerysec.com/">https://docs.archerysec.com/</a></li>
  <li><a href="https://developers.archerysec.com/">https://developers.archerysec.com/</a></li>
</ul>


			</div>

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2019-05-10">10 May 2019</time></span>           
                
                </small>
            </p>
            
			<!-- Post Categories -->
			<div class="after-post-tags">
				<ul class="tags">
                    
                    
                    <li>
                     <a href="/category/tutorial/">Tutorial</a>
                    </li>
                    
				</ul>
			</div>
			<!-- End Categories -->
            
            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="http://localhost:4000/HITB-Armory-Tools-Showcase/"> &laquo; HITB Armory – Tools Showcase 2018</a>
            
            
            <a class="next d-block col-md-6 text-lg-right" href="http://localhost:4000/Deploy-ArcherySec-as-a-Serverless-on-AWS-using-Zappa/">Deploy ArcherySec as a Serverless on AWS using Zappa &raquo; </a>
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

		</div>
		<!-- End Post -->

	</div>
</div>
<!-- End Article
================================================== -->

  

<!-- Begin Comments
================================================== -->

    <div class="container">
        <div id="comments" class="row justify-content-center mb-5">
            <div class="col-md-8">              
                <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'archerysec'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
                
            </div>
        </div>
    </div>

<!--End Comments
================================================== -->
            </div>

        </div>
    </div>
</div>

<!-- Categories Jumbotron
================================================== -->
<div class="jumbotron fortags">
    <div class="d-flex h-100">
        <div class="col-md-4 align-self-center text-center h-100">
            <div class="d-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block d-none align-self-center">Explore →</h2>
            </div>
        </div>
        <div class="col-md-8 align-self-center text-center">
            
            
            
            <a href="/categories.html#tutorial">Tutorial (3)</a>
            
            <a href="/categories.html#introduction">Introduction (5)</a>
            
            <a href="/categories.html#conference">Conference (4)</a>
            
            
            

        </div>
    </div>
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                Copyright © 2022 ArcherySec
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">
                <a target="_blank" href="https://archerysec.com">ArcherySec</a> by ArcherySec Maintainer
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://cdn.rawgit.com/christian-fei/Simple-Jekyll-Search/master/dest/simple-jekyll-search.min.js"></script>

<script src="/assets/js/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>

<script src="/assets/js/ie10-viewport-bug-workaround.js"></script>

<script src="/assets/js/mediumish.js"></script>

<script id="dsq-count-scr" src="//archerysec.disqus.com/count.js"></script>
<script>
var sjs = SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('results-container'),
  json: '/search.json'
})
</script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-129306935-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129306935-1');
</script>



</body>
</html>
